# Project Context Snapshot
Project Root: /home/steam/Wagstaff-Lab

## 1. Directory Structure
```text
â”œâ”€â”€ bin
â”‚   â”œâ”€â”€ boot.sh
â”‚   â””â”€â”€ dst_tool.sh
â”œâ”€â”€ conf
â”‚   â””â”€â”€ settings.ini
â”œâ”€â”€ data
â”œâ”€â”€ devtools
â”‚   â””â”€â”€ snapshot.py
â”œâ”€â”€ project_context.txt
â””â”€â”€ src
    â”œâ”€â”€ explorer.py
    â””â”€â”€ utils.py

```

## 2. Key File Contents
### File: bin/dst_tool.sh
```bash
#!/bin/bash

# =========================================================
# Wagstaff-Lab Control Center v6.1
# æ¨¡å—åŒ– DST æœåŠ¡å™¨ç®¡ç†è„šæœ¬
# =========================================================

# --- 1. ç¯å¢ƒåˆå§‹åŒ– ---

# è·å–è„šæœ¬æ‰€åœ¨ç›®å½•çš„ç»å¯¹è·¯å¾„ (bin/)
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
# å®šä½é¡¹ç›®æ ¹ç›®å½• (Wagstaff-Lab/)
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
# é…ç½®æ–‡ä»¶è·¯å¾„
CONFIG_FILE="$PROJECT_ROOT/conf/settings.ini"

# --- 2. é…ç½®è¯»å–å‡½æ•° (INI Parser) ---
# ç”¨é€”ï¼šä» settings.ini è¯»å–å˜é‡ï¼Œå¹¶è‡ªåŠ¨å°† ~ æ›¿æ¢ä¸º $HOME
read_config() {
    local section=$1
    local key=$2
    local val=$(awk -F ' = ' -v section="[$section]" -v key="$key" '
        $0 == section { in_section=1; next }
        /^\[/ { in_section=0 }
        in_section && $1 == key { print $2; exit }
    ' "$CONFIG_FILE")
    
    # æ›¿æ¢ ~ ä¸ºå½“å‰ç”¨æˆ· Home ç›®å½•
    echo "${val/\~/$HOME}"
}

# --- 3. åŠ è½½å˜é‡ ---
if [ ! -f "$CONFIG_FILE" ]; then
    echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶ $CONFIG_FILE"
    exit 1
fi

DST_DIR=$(read_config "PATHS" "DST_ROOT")
STEAMCMD_DIR=$(read_config "PATHS" "STEAMCMD_DIR")
BACKUP_REPO=$(read_config "PATHS" "BACKUP_DIR")
CLUSTER_NAME=$(read_config "SERVER" "CLUSTER_NAME")
KLEI_HOME=$(read_config "SERVER" "KLEI_HOME")

# [å…³é”®ä¿®æ”¹] å¯åŠ¨è„šæœ¬æŒ‡å‘åŒç›®å½•ä¸‹çš„ boot.sh
START_SCRIPT="$SCRIPT_DIR/boot.sh"

# æ—¥å¿—è·¯å¾„
LOG_MASTER="$KLEI_HOME/$CLUSTER_NAME/Master/server_log.txt"
LOG_CAVES="$KLEI_HOME/$CLUSTER_NAME/Caves/server_log.txt"

# å¯»æ‰¾ Conda Python ç¯å¢ƒ (ä¼˜å…ˆæ‰¾ dst_lab)
PYTHON_EXEC="$HOME/miniconda3/envs/dst_lab/bin/python"
if [ ! -f "$PYTHON_EXEC" ]; then
    # å¤‡ç”¨ï¼šå°è¯•ç³»ç»Ÿ python3
    PYTHON_EXEC=$(which python3)
fi

# ç¡®ä¿å¤‡ä»½ç›®å½•å­˜åœ¨
mkdir -p "$BACKUP_REPO"

# --- é¢œè‰²å®šä¹‰ ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

trap 'echo -e "\n${YELLOW}>> è¿”å›ä¸»èœå•...${NC}"; sleep 0.5' SIGINT

# ================= è¾…åŠ©å‡½æ•° =================

print_line() { echo -e "${CYAN}----------------------------------------${NC}"; }
pause() { echo -e "\n${WHITE}æŒ‰å›è½¦é”®ç»§ç»­...${NC}"; read -r; }

check_status() {
    local master_status="${RED}ğŸ”´ æœªè¿è¡Œ${NC}"
    local caves_status="${RED}ğŸ”´ æœªè¿è¡Œ${NC}"
    if screen -ls | grep -q "DST_Master"; then master_status="${GREEN}ğŸŸ¢ è¿è¡Œä¸­${NC}"; fi
    if screen -ls | grep -q "DST_Caves"; then caves_status="${GREEN}ğŸŸ¢ è¿è¡Œä¸­${NC}"; fi
    echo -e "   åœ°é¢: $master_status    æ´ç©´: $caves_status"
}

# æŸ¥çœ‹æ—¥å¿—å‡½æ•°
view_log() {
    local logfile="$1"; local name="$2"
    if [ -f "$logfile" ]; then
        echo -e "${CYAN}ğŸ“º ç›‘è§† $name æ—¥å¿— (Ctrl+C é€€å‡º)${NC}"
        tail -f "$logfile"
    else
        echo -e "${RED}âŒ æ— æ—¥å¿—æ–‡ä»¶: $logfile${NC}"; pause
    fi
}

# å‘é€æŒ‡ä»¤çš„æ ¸å¿ƒå‡½æ•°
send_cmd_to_master() {
    local cmd="$1"
    local desc="$2"
    if ! screen -ls | grep -q "DST_Master"; then
        echo -e "${RED}âŒ åœ°é¢æœæœªè¿è¡Œ${NC}"; pause; return
    fi
    echo -e "${BLUE}ğŸ“¡ $desc${NC}"
    screen -S "DST_Master" -p 0 -X eval "stuff \"$cmd\015\""
    echo -e "${YELLOW}â³ æŒ‡ä»¤å·²å‘é€${NC}"; sleep 1
}

# ================= æ ¸å¿ƒåŠŸèƒ½æ¨¡å— =================

start_server() {
    print_line
    if screen -ls | grep -q "DST_Master"; then
        echo -e "${YELLOW}âš ï¸  æœåŠ¡å™¨å·²åœ¨è¿è¡Œï¼${NC}"; pause; return
    fi
    echo -e "${GREEN}ğŸš€ è°ƒç”¨å¯åŠ¨å¼•å¯¼ç¨‹åº (Bootloader)...${NC}"
    
    # æ£€æŸ¥å¯åŠ¨è„šæœ¬æ˜¯å¦å­˜åœ¨
    if [ -f "$START_SCRIPT" ]; then
        # æ‰§è¡Œ boot.sh
        "$START_SCRIPT"
    else
        echo -e "${RED}âŒ æ‰¾ä¸åˆ°å¯åŠ¨å™¨: $START_SCRIPT${NC}"
        echo "è¯·æ£€æŸ¥ bin/boot.sh æ˜¯å¦å­˜åœ¨ã€‚"
    fi
    pause
}

graceful_stop() {
    print_line
    echo -e "${YELLOW}ğŸ›‘ å‘é€åœæœä¿¡å·...${NC}"
    if ! screen -ls | grep -qE "DST_Master|DST_Caves"; then
        echo -e "${RED}âš ï¸  æœåŠ¡å™¨æœªè¿è¡Œ${NC}"; pause; return
    fi

    # å‘é€å…³é—­æŒ‡ä»¤
    for target in "DST_Master" "DST_Caves"; do
        if screen -list | grep -q "$target"; then
            screen -S "$target" -p 0 -X eval 'stuff "c_shutdown(true)\015"'
        fi
    done

    echo -e "${BLUE}â³ ç­‰å¾…å­˜æ¡£ä¿å­˜ (æœ€å¤š40ç§’)...${NC}"
    for ((i=1; i<=40; i++)); do
        if ! screen -list | grep -qE "DST_Master|DST_Caves"; then
            echo -e "\n${GREEN}âœ… æœåŠ¡å™¨å·²å…³é—­${NC}"; pause; return
        fi
        if tail -n 10 "$LOG_MASTER" 2>/dev/null | grep -q "Shutting down"; then
            echo -e "\n${GREEN}âœ… ç›‘æµ‹åˆ°å…³æœºä¿¡å·${NC}"; break
        fi
        echo -n "."; sleep 0.5
    done
    
    # æ¸…ç†æ®‹ä½™è¿›ç¨‹
    screen -list | grep -E "DST_Master|DST_Caves" | cut -d. -f1 | xargs -r -I{} screen -S {} -X quit
    echo -e "\n${GREEN}âœ… è¿›ç¨‹å·²ç»ˆæ­¢${NC}"; pause
}

restart_server() {
    print_line
    if screen -ls | grep -qE "DST_Master|DST_Caves"; then
        eval "original_pause_def=$(declare -f pause)"; pause() { :; } 
        graceful_stop
        eval "$original_pause_def"
    fi
    read -p "æ˜¯å¦é¡ºä¾¿æ›´æ–°æ¸¸æˆ? (y/n): " up_c
    if [[ "$up_c" == "y" ]]; then update_game; fi
    start_server
}

update_game() {
    print_line
    echo -e "${BLUE}â¬‡ï¸  è°ƒç”¨ SteamCMD æ›´æ–°...${NC}"
    "$STEAMCMD_DIR/steamcmd.sh" +force_install_dir "$DST_DIR" +login anonymous +app_update 343050 validate +quit
    echo -e "${GREEN}âœ… æ›´æ–°å®Œæˆ${NC}"; pause
}

# --- å¤‡ä»½/æ¢å¤ç³»ç»Ÿ ---
create_backup() {
    print_line
    local ts=$(date +"%Y%m%d_%H%M%S")
    if [ ! -d "$KLEI_HOME/$CLUSTER_NAME" ]; then echo -e "${RED}âŒ å­˜æ¡£ä¸å­˜åœ¨: $KLEI_HOME/$CLUSTER_NAME${NC}"; pause; return; fi
    
    echo -e "${CYAN}ğŸ’¾ æ‰“åŒ…å­˜æ¡£: $CLUSTER_NAME ...${NC}"
    tar -zcf "$BACKUP_REPO/backup_${ts}.tar.gz" -C "$KLEI_HOME" "$CLUSTER_NAME"
    echo -e "${GREEN}âœ… å¤‡ä»½å·²åˆ›å»º: backup_${ts}.tar.gz${NC}"; pause
}

restore_backup() {
    print_line
    files=($(ls -1t "$BACKUP_REPO"/*.tar.gz 2>/dev/null))
    if [ ${#files[@]} -eq 0 ]; then echo -e "${RED}âŒ å¤‡ä»½åº“ä¸ºç©º${NC}"; pause; return; fi

    echo -e "${CYAN}ğŸ“‚ æœ€è¿‘å¤‡ä»½:${NC}"
    i=0
    for file in "${files[@]}"; do
        echo -e " [$i] $(basename "$file")"
        ((i++)); if [ $i -ge 10 ]; then break; fi
    done
    
    read -p "é€‰æ‹©åºå· (qé€€å‡º): " c
    if [[ "$c" == "q" ]]; then return; fi
    if ! [[ "$c" =~ ^[0-9]+$ ]] || [ "$c" -ge "$i" ]; then echo "âŒ æ— æ•ˆ"; pause; return; fi

    read -p "âš ï¸  é«˜å±æ“ä½œ: ç¡®è®¤è¦†ç›–å½“å‰å­˜æ¡£? (YES/n): " confirm
    if [[ "$confirm" != "YES" ]]; then return; fi

    # è‡ªåŠ¨åœæœ
    if screen -ls | grep -qE "DST_Master|DST_Caves"; then
        eval "original_pause_def=$(declare -f pause)"; pause() { :; } 
        graceful_stop
        eval "$original_pause_def"
    fi

    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†æ—§å­˜æ¡£...${NC}"
    rm -rf "$KLEI_HOME/$CLUSTER_NAME"
    echo -e "${BLUE}ğŸ“¦ è§£å‹å¤‡ä»½...${NC}"
    tar -zxf "${files[$c]}" -C "$KLEI_HOME"
    echo -e "${GREEN}âœ… å›æ¡£æˆåŠŸ${NC}"
    read -p "ç«‹å³å¯åŠ¨? (y/n): " sn
    if [[ "$sn" == "y" ]]; then start_server; else pause; fi
}

# --- Wagstaff å·¥å…·ç®±é›†æˆ ---
run_explorer() {
    local script_path="$PROJECT_ROOT/src/explorer.py"
    if [ -f "$script_path" ]; then
        "$PYTHON_EXEC" "$script_path"
    else
        echo -e "${RED}âŒ æ‰¾ä¸åˆ°å·¥å…·è„šæœ¬: $script_path${NC}"
        pause
    fi
}

console_menu() {
    while true; do
        clear
        echo -e "   ğŸ® ${CYAN}æ§åˆ¶å°æŒ‡ä»¤ä¸­å¿ƒ${NC} ğŸ®"
        check_status
        echo "--------------------------------"
        echo "1. ğŸ’¾ ç«‹å³ä¿å­˜ (c_save)"
        echo "2. âª å›æ»š1å¤© (c_rollback)"
        echo "3. ğŸ“¢ å‘é€å…¬å‘Š (c_announce)"
        echo "4. â˜ ï¸  é‡ç½®ä¸–ç•Œ (c_regenerateworld)"
        echo "5. ğŸ‘¥ åˆ—å‡ºç©å®¶"
        echo "0. ğŸ”™ è¿”å›"
        echo "--------------------------------"
        read -p "æŒ‡ä»¤: " cc
        case $cc in
            1) send_cmd_to_master "c_save()" "ç«‹å³ä¿å­˜" ;;
            2) send_cmd_to_master "c_rollback(1)" "å›æ»š1å¤©" ;;
            3) read -p "å†…å®¹: " m; send_cmd_to_master "c_announce(\"$m\")" "å…¬å‘Š" ;;
            4) read -p "è¾“å…¥ YES ç¡®è®¤é‡ç½®: " r; [[ "$r" == "YES" ]] && send_cmd_to_master "c_regenerateworld()" "é‡ç½®ä¸–ç•Œ" ;;
            5) send_cmd_to_master "c_listallplayers()" "ç©å®¶åˆ—è¡¨" ;;
            0) return ;;
        esac
    done
}

# ================= ä¸»å¾ªç¯ =================
while true; do
    clear
    echo "==========================================="
    echo -e " ğŸ¦… ${CYAN}Wagstaff-Lab æ§åˆ¶å° v6.1${NC} ğŸ¦…"
    echo "==========================================="
    check_status
    echo -e "${CYAN}--- è¿ç»´ç®¡ç† ---${NC}"
    echo "1. ğŸš€ å¯åŠ¨æœåŠ¡å™¨      2. ğŸ›‘ åœæ­¢æœåŠ¡å™¨"
    echo "3. ğŸ”„ é‡å¯æœåŠ¡å™¨      4. â¬‡ï¸  æ›´æ–°ç‰ˆæœ¬"
    echo -e "${CYAN}--- æ•°æ®ä¸å·¥å…· ---${NC}"
    echo "5. ğŸ’¾ åˆ›å»ºå¤‡ä»½        6. âª æ¢å¤å­˜æ¡£"
    echo "7. ğŸ“œ æŸ¥çœ‹æ—¥å¿—        8. ğŸ® å‘é€æŒ‡ä»¤"
    echo -e "9. ğŸ”¬ ${YELLOW}æºç é€è§†é•œ (Explorer)${NC}"
    echo "0. ğŸšª é€€å‡º"
    echo "==========================================="
    
    read -p "é€‰é¡¹: " choice

    case $choice in
        1) start_server ;;
        2) graceful_stop ;;
        3) restart_server ;;
        4) update_game ;;
        5) create_backup ;;
        6) restore_backup ;;
        7) view_log "$LOG_MASTER" "Master" ;; 
        8) console_menu ;;
        9) run_explorer ;; 
        0) echo -e "${GREEN}å†è§ï¼Œç ”ç©¶å‘˜ã€‚${NC}"; exit 0 ;;
        *) echo "æ— æ•ˆ"; sleep 0.5 ;;
    esac
done

```

### File: src/explorer.py
```py
#!/usr/bin/env python3
import os
import zipfile
import sys
from rich.console import Console
from rich.table import Table
from rich.tree import Tree
from rich.panel import Panel
from rich.prompt import Prompt, IntPrompt
from rich.syntax import Syntax
from rich import box

# === å¼•å…¥ Wagstaff å·¥å…·åº“ ===
# å°† src ç›®å½•åŠ å…¥è·¯å¾„ï¼Œä»¥ä¾¿å¯¼å…¥ utils
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
from utils import wagstaff_config

# åˆå§‹åŒ– Rich
console = Console()

class DSTExplorer:
    def __init__(self):
        # ä»ç»Ÿä¸€é…ç½®è¯»å–è·¯å¾„
        self.base_dir = wagstaff_config.get('PATHS', 'DST_ROOT')
        self.zip_path = os.path.join(self.base_dir, "data", "databundles", "scripts.zip")
        self.fallback_dir = os.path.join(self.base_dir, "data", "scripts")
        
        self.mode = None 
        self.source = None
        self.file_list = []
        self.root_prefix = "scripts/" 
        
        self.init_source()

    def init_source(self):
        console.print(Panel(f"[bold cyan]Wagstaff æºç é€è§†é•œ v2.1[/bold cyan]\nç›®æ ‡æº: {self.base_dir}", border_style="blue"))

        if os.path.exists(self.zip_path):
            self.mode = 'zip'
            self.source = zipfile.ZipFile(self.zip_path, 'r')
            self.file_list = self.source.namelist()
            console.print(f"[green]âœ… å·²æŒ‚è½½ ZIP æ ¸å¿ƒ: scripts.zip ({len(self.file_list)} files)[/green]")
        elif os.path.exists(self.fallback_dir):
            self.mode = 'folder'
            self.source = self.fallback_dir
            for root, _, files in os.walk(self.fallback_dir):
                for name in files:
                    rel_path = os.path.relpath(os.path.join(root, name), self.fallback_dir)
                    self.file_list.append(rel_path)
            console.print(f"[green]âœ… å·²æŒ‚è½½æ–‡ä»¶å¤¹: scripts/ ({len(self.file_list)} files)[/green]")
        else:
            console.print(f"[bold red]âŒ è‡´å‘½é”™è¯¯ï¼šåœ¨ {self.base_dir} æœªæ‰¾åˆ° scripts æ•°æ®ï¼[/bold red]")
            console.print("è¯·æ£€æŸ¥ conf/settings.ini é…ç½®æ˜¯å¦æ­£ç¡®ã€‚")
            sys.exit(1)

    def get_structure_tree(self):
        tree = Tree(f"ğŸ“ [bold yellow]æºç ç»“æ„ ({self.mode})[/bold yellow]")
        dir_counts = {}
        for f in self.file_list:
            clean_path = f.replace(self.root_prefix, "", 1) if f.startswith(self.root_prefix) else f
            top_dir = clean_path.split('/')[0] if '/' in clean_path else "[Root Files]"
            dir_counts[top_dir] = dir_counts.get(top_dir, 0) + 1

        for d, count in sorted(dir_counts.items(), key=lambda x: x[1], reverse=True):
            if d == "[Root Files]":
                tree.add(f"ğŸ“„ {d} ({count})")
            else:
                style = "bold cyan" if d in ["prefabs", "components", "tuning.lua"] else "white"
                tree.add(f"ğŸ“‚ [{style}]{d}[/{style}] ([dim]{count}[/dim])")
        return tree

    def search_files(self):
        keyword = Prompt.ask("[bold green]ğŸ” æœç´¢å…³é”®è¯[/bold green]")
        if not keyword: return
        matches = [f for f in self.file_list if keyword.lower() in f.lower()]
        
        if not matches:
            console.print("[yellow]æ— ç»“æœ[/yellow]")
            return

        table = Table(title=f"Results: '{keyword}'", box=box.SIMPLE)
        table.add_column("è·¯å¾„", style="dim")
        table.add_column("æ–‡ä»¶", style="bold green")
        for m in matches[:15]:
            d, f = os.path.split(m)
            table.add_row(d, f)
        console.print(table)
        if len(matches) > 15: console.print(f"[dim]...å‰©ä½™ {len(matches)-15} é¡¹éšè—[/dim]")

    def read_content(self, filepath):
        try:
            if self.mode == 'zip':
                with self.source.open(filepath) as f: return f.read().decode('utf-8', errors='replace')
            else:
                with open(os.path.join(self.source, filepath), 'r', encoding='utf-8') as f: return f.read()
        except Exception as e:
            console.print(f"[red]Error: {e}[/red]")
            return None

    def preview_file(self):
        target = Prompt.ask("[bold green]ğŸ‘€ æ–‡ä»¶å[/bold green]")
        candidates = [f for f in self.file_list if target.lower() in f.lower()]
        if not candidates: return console.print("[red]æœªæ‰¾åˆ°[/red]")
        
        target_file = candidates[0]
        if len(candidates) > 1: console.print(f"[yellow]æ‰“å¼€æœ€åŒ¹é…é¡¹: {target_file}[/yellow]")
        
        content = self.read_content(target_file)
        if content:
            syntax = Syntax("\n".join(content.splitlines()[:50]), "lua", theme="monokai", line_numbers=True)
            console.print(Panel(syntax, title=f"{target_file} (Top 50 lines)", border_style="blue"))
            input("æŒ‰å›è½¦ç»§ç»­...")

    def show_tuning(self):
        path = f"{self.root_prefix}tuning.lua"
        if path not in self.file_list: path = "tuning.lua"
        
        content = self.read_content(path)
        if not content: return console.print("[red]Tuning.lua not found[/red]")
        
        console.print("[bold magenta]ğŸ”¢ Tuning æ•°å€¼é‡‡æ ·[/bold magenta]")
        count = 0
        for line in content.splitlines():
            line = line.strip()
            if ' = ' in line and line[0].isupper() and "--" not in line:
                console.print(f"  [cyan]{line}[/cyan]")
                count += 1
                if count >= 10: break

def main():
    explorer = DSTExplorer()
    while True:
        console.print("\n[bold white on blue] ğŸ¦ Wagstaff æ¢ç´¢é¢æ¿ [/bold white on blue]")
        console.print("1. [bold]ğŸ“ ç»“æ„[/]  2. [bold]ğŸ” æœç´¢[/]  3. [bold]ğŸ‘€ é¢„è§ˆ[/]  4. [bold]ğŸ”¢ æ•°å€¼[/]  0. [bold red]é€€å‡º[/]")
        choice = IntPrompt.ask("é€‰æ‹©", choices=["0","1","2","3","4"], default=1)
        if choice == 0: break
        elif choice == 1: console.print(explorer.get_structure_tree())
        elif choice == 2: explorer.search_files()
        elif choice == 3: explorer.preview_file()
        elif choice == 4: explorer.show_tuning()

if __name__ == "__main__":
    main()

```

### File: conf/settings.ini
```ini
[PATHS]
# æ¸¸æˆå®‰è£…ç›®å½•
DST_ROOT = ~/dontstarvetogether_dedicated_server
# SteamCMD ç›®å½•
STEAMCMD_DIR = ~/steamcmd
# å¤‡ä»½å­˜æ”¾ç›®å½•
BACKUP_DIR = ~/dst_backups

[SERVER]
# ä½ çš„å­˜æ¡£æ–‡ä»¶å¤¹å (Cluster Name)
CLUSTER_NAME = MyDediServer
# Klei å­˜æ¡£æ ¹ç›®å½• (é€šå¸¸æ˜¯ ~/.klei/DoNotStarveTogether)
KLEI_HOME = ~/.klei/DoNotStarveTogether

```
